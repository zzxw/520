<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>图纸管理系统</title>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/fontAwesome.css">
        <link rel="stylesheet" href="css/light-box.css">
        <link rel="stylesheet" href="css/templatemo-main.css">
		
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">
		<link rel="stylesheet" href="css/my.css" />
        <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
        <style>
        	.table-striped tbody tr:nth-child(even) td,
			.table-striped tbody tr:nth-child(even) th {background-color:#D4FFFF;}
			.table-striped tbody tr:nth-child(odd) td,
			.table-striped tbody tr:nth-child(odd) th {background-color:#D4BFFF;}
        </style>
        
    </head>

<body>
    
    <div class="sequence">
      <div class="seq-preloader">
        <svg width="39" height="16" viewBox="0 0 39 16" xmlns="http://www.w3.org/2000/svg" class="seq-preload-indicator"><g fill="#F96D38"><path class="seq-preload-circle seq-preload-circle-1" d="M3.999 12.012c2.209 0 3.999-1.791 3.999-3.999s-1.79-3.999-3.999-3.999-3.999 1.791-3.999 3.999 1.79 3.999 3.999 3.999z"/><path class="seq-preload-circle seq-preload-circle-2" d="M15.996 13.468c3.018 0 5.465-2.447 5.465-5.466 0-3.018-2.447-5.465-5.465-5.465-3.019 0-5.466 2.447-5.466 5.465 0 3.019 2.447 5.466 5.466 5.466z"/><path class="seq-preload-circle seq-preload-circle-3" d="M31.322 15.334c4.049 0 7.332-3.282 7.332-7.332 0-4.049-3.282-7.332-7.332-7.332s-7.332 3.283-7.332 7.332c0 4.05 3.283 7.332 7.332 7.332z"/></g></svg>
      </div>
    </div>
        <nav>
          <div class="logo">
              <img src="img/logo.png" alt="">
              <div class="userInfo" style="background-color: #4CAE4C;">
              	<p class="userInfo"></p>
              	<button onclick="out();">退出</button>
              </div>
          </div>
          <div class="mini-logo">
              <img src="img/mini_logo.png" alt="">
          </div>
          <ul>
            <li><a href="#1" id="a1"><i class="fa fa-home"></i> <em>Home</em></a></li>
            <li><a href="#2" id="a2" onclick="viewProfile();"><i class="fa fa-image"></i> <em>Profile</em></a></li>
            <li><a href="#3" id="a3" onclick="managerUser();"><i class="fa fa-user"></i> <em>user Manager</em></a></li>
          </ul>
        </nav>
        
        <div class="slides">
          <div class="slide" id="1">
            <div class="content first-content">
              <div class="container-fluid">
                  <div class="col-md-3">
                      <div class="author-image"><img src="img/author_image.png" alt=""></div>
                  </div>
                  <div class="col-md-9">
                      <h2>Overview</h2>
                      <ul class="operate-project">
                      	<li><a href="#4"class="active">新增项目</a></li>
                      	<li><a href="#5">修改项目</a></li>
                      	<li><a href="#" onclick="window.location.href='modify.html';">查看项目</a></li>
                      	<input type="text" hidden="hidden" id="uName"></input>
                      </ul>
                  </div>
              </div>
            </div>
          </div>
          <div class="slide" id="2">
            <div class="content first-content">
              <!--<div class="container-fluid">-->
                  <div class="col-md-9">
                      <ul class="operate-user">
                      </ul>
                      <div id="graph" style="width: 600px; height: 400px;"></div>
                  </div>
              <!--</div>-->
            </div>
          </div>
          <div class="slide" id="3">
          	<div class="content fourth-content">
          		<div class="col-md-6">
                            <div class="row">
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="uid" type="text" class="form-control" id="uid" placeholder="用户id" required="" disabled="disabled">
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="uName" type="text" class="form-control" id="uName" placeholder="用户名" required="" disabled="disabled">
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="phone" type="tel" rows="6" class="form-control" id="phone" placeholder="手机号" required="" disabled="disabled"></input>
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="mail" type="text" rows="6" class="form-control" id="mail" placeholder="用户邮箱" required="" disabled="disabled"></input>
                                  </fieldset>
                                </div>
                                <button onclick="modifyUserInfo();">修改用户信息</button>
                                <button onclick="modifyPwd();">修改密码</button>
                            </div>
                    </div>
          	</div>
          </div>
          <div class="slide" id="4">
            <div class="content fifth-content">
                <div class="container-fluid">
                    <div class="col-md-6">
                    </div>
                    <div class="col-md-6">
                        <form id="contact">
                            <div class="row">
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="name" type="text" class="form-control" id="pName" placeholder="项目名称" required="">
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="unitName" type="text" class="form-control" id="unitName" placeholder="项目单位" required="">
                                  </fieldset>
                                </div>
                                 <div class="col-md-12">
                                  <fieldset>
                                    <input name="contacts" type="text" class="form-control" id="contacts" placeholder="联系人" required="">
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="cPhone" type="tel" rows="6" class="form-control" id="cPhone" placeholder="手机号" required="" onblur="phoneCheck();"></input>
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <input name="major" type="text" rows="6" class="form-control" id="pType" placeholder="专业类别" required=""></input>
                                  </fieldset>
                                </div>
                                <div class="col-md-12">
                                  <!-- <fieldset> -->
                                    <!-- <input name="uId" type="text" rows="6" class="form-control" id="uId" placeholder="设计人员"></input> -->
                                 	<span>设计人员:</span><select id="uId">
                                 	</select>
                                  <!-- </fieldset> -->
                                </div>
                                <div class="col-md-12">
                                  <!-- <fieldset> -->
                                  	<span>审图人员:</span><select id="checkId">
                                  	</select>
                                    <!-- <input name="checkId" type="text" rows="6" class="form-control" id="checkId" placeholder="审图人员"></input> -->
                                  <!-- </fieldset> -->
                                </div>
                                <div class="col-md-12">
                                  <!-- <fieldset> -->
                                    <span>审核人员</span><select id="authorizedId">
                                    </select>
                                    <!-- <input name="authorizedId" type="text" rows="6" class="form-control" id="authorizedId" placeholder="审核人员"></input> -->
                                  <!-- </fieldset> -->
                                </div>
                                <div class="col-md-12">
                                  <fieldset>
                                    <button id="form-submit" class="btn">增加工程</button>
                                  </fieldset>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
          </div>
	     <div class="slide" id="5">
          	<div class="content fourth-content">
          		<div class="modifyProject">
          			<table class="table table-striped">
          				<thead align="center">
							<tr style="color:yellow">
								<th>项目名称</th>
								<th>单位名称</th>
								<th>联系人</th>
								<th>联系方式</th>
								<th>项目类型</th>
								<th>设计人员</th>
								<th>审图人员</th>
								<th>审核人员</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody class="projectBody">
						</tbody>
          			</table>
          			<ul class="pagination">
					   
					</ul><br>
          		</div>
          	</div>
          </div>
	      	<div class="content fourth-content">
	      		<div class="projectContainer"></div>
	      	</div>
	      </div>
        </div>

        <div class="footer">
         <!-- <div class="content">
              <p>Copyright &copy; 2018 Your Company . <a href="#">Moonlight</a> by <a href="#" target="_parent">HTML5 Max</a></p>
              <div class="tlinks"><p>CorpRigth?2018HyitFz</p></div>
          </div>-->
        </div>

    
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>
	<!--<script type="text/javascript" src="js/jquery-3.2.0.min.js" ></script>-->
	<script type="text/javascript" src="js/jquery.min.js" ></script>
	<script type="text/javascript" src="js/jquery.cookie.js" ></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    
    <script src="js/datepicker.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/main.js"></script>
	<script type="text/javascript" src="js/main.js" ></script>
    <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script> -->
    <script type="text/javascript" src="js/echarts.js" ></script>
    <script type="text/javascript" src="js/getParameter.js" ></script>
    <script type="text/javascript">
    	$(document).ready(function() {
	        $('.scroll-link').on('click', function(event){
	            event.preventDefault();
	            var sectionID = $(this).attr("data-id");
	            scrollToID('#' + sectionID, 750);
	        });
	        $('.scroll-top').on('click', function(event) {
	            event.preventDefault();
	            $('html, body').animate({scrollTop:0}, 'slow');         
	        });
	        $('#nav-toggle').on('click', function (event) {
	            event.preventDefault();
	            $('#main-nav').toggleClass("open");
	        });
	        modifyProject(1);
	    });
	    //var cookie = document.cookie;
	    var uName = $.cookie("name");
	    var uId = $.cookie('id');
	    $("p.userInfo").val("欢迎您，" + uName);
	    var phone = '';
	    var mail = '';
	    if(typeof(uName) == 'undefined' || uName.trim() == '') {
	    	alert("你还未登陆，请先登陆!");
	    	window.location.href = 'login.html';
	    }
    	$("#uName").val(uName);
    	function viewProfile(){
    		var myChart = echarts.init($("#graph").get(0));
         	var option = {
				title : {
					text : 'test'
				},
				tooltip : {
			        trigger: 'item',
			        formatter: "{a} <br/>{b} : {c} ({d}%)"
			    },
				legend : {
					data : []
				},
				series : {
					name : 'test',
					type : 'pie',
					label : {
						normal : {
							show : true,
							formatter: '{b}:{c}: ({d}%)',
							textStyle : {
								fontWeight : 'normal',
								fontSize : 14
							}
						}
					}, 
					data : []
				}
			};
	        $.ajax({
	        	type:"get",
	        	url:"Project/adminStatistics.do",
	        	async:true,
	        	dataType : 'json',
	        	success:function(result){
	        		var data;
	        		if(result.state == 0){
	        			data = result.data;
	        			data = eval('(' +data + ')');
	        			option.legend.data = data;
	        			option.series.data = data;        			
	        			myChart.setOption(option);
	        		}else{
	        			alert(result.message);
	        		}
	        	}
	        });
    	}
    	function managerUser(){
    		var uName = document.cookie.split("=")[1];
    		$.ajax({
    			type:"get",
    			url:"worker/find.do",
    			async:true,
    			dataType : 'json',
    			data : {
    				name : uName
    			},
    			success : function(result) {
    				var data = result.data;
    				$("input#uid").val(data.uid);
    				$("input#uName").val(data.uName);
    				$("input#phone").val(data.phone);
    				$("input#mail").val(data.mail);
    				uName = data.uName;
    				phone = data.phone;
    				mail = data.mail;
    			}
    		});
    	}
	    var href = location.href;
	    if(href.indexOf("#")!=-1){
	    	var id = href.substr(href.indexOf('#')+1);
	    	location.href = href.substring(href.indexOf('#'));
	    	$("#a1").removeClass('active');
	    	$("#a" + id).addClass('active');
	    }
	    function scrollToID(id, speed){
	        var offSet = 0;
	        var targetOffset = $(id).offset().top - offSet;
	        var mainNav = $('#main-nav');
	        $('html,body').animate({scrollTop:targetOffset}, speed);
	        if (mainNav.hasClass("open")) {
	            mainNav.css("height", "1px").removeClass("in").addClass("collapse");
	            mainNav.removeClass("open");
	        }
	    }
	    if (typeof console === "undefined") {
	        console = {
	            log: function() { }
	        };
	    }
	    function phoneCheck(){
	    	var cPhone = $("#phone").val();
	    	if(cPhone == null || typeof(cPhone)=='undefined' || cPhone.trim() == '') {
	    		return false;
	    		alert("手机号不能为空!!!!");
	    	}
	    	var phoneReg = "^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$";
	    	if(!cPhone.match(phoneReg)){
	    		return false;
	    		alert("手机号格式不正确，请填写正确的手机号");
	    	}
	    	if(cPhone == phone){
	    		return false;
	    	}
	    }
	    function isEmpty(data){
	    	if(data == null || typeof(data) == 'undefined' || data.trim()==''){
	    		return true;
	    	}
	    	return false;
	    }
	    $("input#pType").blur(function(){
	    	var myPtype = $("input#pType").val();
	    	if(myPtype.trim() == ''){
	    		alert('工程专业类别不能为空');
	    		return;
	    	}
	    	var myDesign = $("select#uId");
	    	var myCheck = $("select#checkId");
	    	var myCheck2 = $("select#authorizedId");
	    	myDesign.empty();
	    	myCheck.empty();
	    	myCheck2.empty();
	    	var successFunction = function(obj){
	    		var myFunction = function(result){
	    			if(result.state == 1){
		    			alert(result.message);
		    		}else{
		    			var data = result.data;
		    			obj.append($("<option></option>"));
		    			for(var i=0;i<data.length;i++){
		    				var option = $("<option value='" + data[i].id + "'>" + data[i].name + "</option>");
		    				obj.append(option);
		    			}
		    		}
	    		}
	    		return myFunction;
	    	};
	    	sendRequest("post","nUser/findUsersByMajor.do",{major:myPtype,userType:1},successFunction(myDesign))
	    	sendRequest("post","nUser/findUsersByMajor.do",{major:myPtype,userType:2},successFunction(myCheck))
	    	sendRequest("post","nUser/findUsersByMajor.do",{major:myPtype,userType:3},successFunction(myCheck2));
	    });
	    $("#form-submit").click(function(){
	    	var pName = $("#pName");
	    	var unitName = $("#unitName");
	    	var contacts = $("#contacts");
	    	var cPhone = $("#cPhone");
	    	var pType = $("#pType");
	    	var uId = $("#uId");
	    	var checkId = $("#checkId");
	    	var authorizedId = $("#authorizedId");
	    	if(isEmpty(pName.val()) || isEmpty(unitName.val()) || isEmpty(contacts.val()) || isEmpty(cPhone.val()) || isEmpty(pType.val())) {
	    		alert("所有字段均需填写");
	    		return;
	    	}
	    	var phoneReg = "^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$";
	    	if(!cPhone.val().match(phoneReg)){
	    		alert("手机号格式不正确，请填写正确的手机号");
	    	}
	    	uId = uId.trim() == ''?-1:uId;
	    	checkId = checkId.trim() == ''?-1:checkId;
	    	authorizedId = authorizedId.trim() == ''?-1:authorizedId;
	    	$.ajax({
	    		type:"post",
	    		url:"Project/add.do",
	    		async:true,
	    		dataType : 'json',
	    		data : {
	    			pName : pName.val(),
	    			unitName : unitName.val(),
	    			contacts : contacts.val(),
	    			cPhone : cPhone.val(),
	    			pType : pType.val(),
	    			uId : uId.val(),
	    			checkId : checkId.val(),
	    			authorizedId : authorizedId.val()
	    		},
	        	success:function(result){
	        		if(result.state == 0){
	        			pName.val('');
	        			unitName.val('');
	        			contacts.val('');
	        			cPhone.val('');
	        			pType.val('');
	        			uId.val('');
	        			checkId.val('');
	        			authorizedId.val('');
	        			window.location.href="index.html";
	        		}else{
	        			alert(result.message);
	        		}
	        	},
	        	error:function(){
	        		alert("发生了未知的错误，请重新尝试");
	        	}
	    	});
	    });
	    function sendRequest(type,url,data,successFunction){
	    	$.ajax({
	    		type:type,
	    		url:url,
	    		async:true,
	    		data :data,
	    		success:successFunction,
	    		error:function(){
	    			alert('发生了未知的错误，请稍后重新尝试');
	    		}
	    	});
	    }
	    function modifyProject(pageNo){
	    	if(typeof(pageNo)=='undefined'){
	    		pageNo = 1;
	    	}
	    	var tbody = $(".projectBody");
	    	tbody.empty();
	    	$.ajax({
	    		type:"get",
	    		url:"Project/searchProjects.do",
	    		async:true,
	    		data:{
	    			pg : pageNo
	    		},
	    		dataType:'json',
	    		success:function(result){
	    			if(result.state == 0){
	    				tbody.empty();
	    				var data = result.data.list;
	    				for(var i=0;i<data.length;i++){
	    					var item = data[i];
	    					var tr = $("<tr></tr>");
	    					tr.append($("<td style='display:none'>" + data[i].pid + "</td>"));
	    					tr.append($("<td>" + data[i].pName + "</td>"));
	    					tr.append($("<td>" + data[i].unitName + "</td>"));
	    					tr.append($("<td>" + data[i].contacts + "</td>"));
	    					tr.append($("<td>" + data[i].cPhone + "</td>"));
	    					tr.append($("<td>" + data[i].pType + "</td>"));
	    					tr.append($("<td>" + data[i].uid + "</td>"));
	    					tr.append($("<td>" + data[i].checkId + "</td>"));
	    					tr.append($("<td>" + data[i].authorizedId + "</td>"));
	    					var td = $("<td><button onclick='modify(this);'>修改</button></td>");
	    					tr.append(td);
	    					tbody.append(tr);
	    				}
	    				var page = $(".pagination");
	    				//page.append($("<li class=''>&laquo;</a></li>"));
	    				for(var i=1;i<=result.data.lastPage;i++){
	    					page.append($("<li class='>"+i+"'></li>"));
	    				}
	    				//page.append($("<li><a href='#'>&raquo;</a></li>"));
	    				var ul = $("li");
	    				for(var i=0;i<ul.length;i++){
	    					var li = ul.get(i);
	    					li.addEventListener('click',function(evt){
								var pn = this.getAttribute('class');
								view(0,pn);
							});
	    				}
	    			}else{
	    				alert(result.message);
	    			}
	    		},
	    		error:function(){
	    			alert('发生了未知错误，请检查网络后重新尝试');
	    		}
	    	});
	    }
	    function modifyUserInfo(){
	    	if(!phoneCheck()){
	    		return;
	    	}
			var emailReg = "^[A-Za-z0-9\\u4e00-\\u9fa5]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$";
			var email = $("#mail").val();
			if(email.trim() == '' || !email.match(emailReg)){
				alert("请输入正确的邮箱格式");
				return;
			}
			if(email == mail && phone == $("#phone").val()){
				alert('信息未发生改动');
				return;
			}
			var data = {};
			if(email != mail){
				data.mail = email;
			}
			if(phone != $("#phone").val()){
				data.phone = $("#phone").val();
			}
			if(data.length>0){
				$.ajax({
					type:"post",
					url:"worker/update.do",
					async:true,
					dataType:'json',
					data: data,
					success:function(result){
						var data = result.data;
						$("#phone").val(data.phone);
						$("#mail").val(data.mail);
						alert("修改信息成功");
					},
					error:function(){
						
					}
				});
			}
	    }
	    function modifyPwd(){
	    	window.location.href = "modifyPwd.html";
	    }
	    /* function view(status,pageNo){
	    	if(typeof(pageNo)=='undefined' || !Number.isNaN(pageNo)){
	    		pageNo = 1;
	    	}
	    } */
	    function modify(str){
	    	var id = str.parentNode.parentNode.childNodes[0].childNodes[0].nodeValue;
	    	window.location.href = 'editProject.html?pid=' + id + "&uName="+uName;
	    }
	    function out(){
	    	$.cookie("name",null);
			$.cookie("uId",null);
			window.location.href = 'login.html';
	    }
    </script>
</body>
</html>